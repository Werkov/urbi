#! /bin/sh

# Exit status.
status=0

# Any tool failure is a failure of the script.
set -e

: ${BISON=@BISON@}

# bison++ SRCDIR INPUT OUTPUT OPTIONS
# -----------------------------------

me=$(basename $0)
move_if_change='@abs_srcdir@/move-if-change'

srcdir=$1
abs_srcdir=$(cd $srcdir && pwd)
shift
input=$1
shift
output=$1
shift
options="$@"

# Alexandre Duret-Lutz also notes that in VPATH-builds $(srcdir) can
# be an absolute path depending on how ./configure is called ...
# In that case

#   bison $(srcdir)/parsetiger.yy [...]

# will hard code the path in the maintainer's tree.  Hence, do not use
# paths with Bison, chdir there.

# A tmp dir.
tmp=$output.dir
rm -rf $tmp
mkdir $tmp

# Compile in this dir.
# Don't use `ln -s' as its semantics of paths sucks.
cp $srcdir/$input $tmp
cd $tmp

set +e
$BISON $options $input -o $output
status=$?
set -e

if test $status = 0; then
    for file in *
    do
	case $file in
	$input)
	    # Leave it here.
	    ;;
	*)
	    # Fix doxygen tags.
	    perl -pi -e "s|\Q\\file $file\E\b|\\\\file parse/$file|g;" "$file"
	    $move_if_change "$file" "$abs_srcdir/$file"
	    ;;
	esac
    done
fi

# Get rid of the tmp dir.
cd ..
rm -rf $tmp
exit $status
