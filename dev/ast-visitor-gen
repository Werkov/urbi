#!/usr/bin/env python

import re
import sys, os, os.path, filecmp, shutil, stat
import ast, tools

from stat import ST_MODE

if len(sys.argv) != 2:
  tools.error("Usage: .. SRCDIR")
srcdir = sys.argv[1]

## Abstract syntax tree C++ visitor - header ----------------------------------
loader = ast.Loader ()
nodes = loader.load (sys.stdin)

visitor_hh = file("visitor.hh.tmp", "w")
sys.stdout = visitor_hh

print tools.banner("ast/visitor.hh",
		   "Definition of ast::Visitor.") + """
#ifndef AST_VISITOR_HH
# define AST_VISITOR_HH

# include <functional>
# include "ast/fwd.hh"
# include "libport/select-const.hh"

namespace ast
{

  /** \\brief Root class of all Ast visitors.
   **
   ** GenVisitor<CONSTIFY> is the root class of all Ast visitors. */
  template < template <typename> class Const >
  class GenVisitor : public std::unary_function<Ast, void>
  {
    /** \\name Ctor & dtor.
     ** \\{ */
  public:
    /// Destroy a GenVisitor.
    virtual ~GenVisitor ();
    /** \\} */

    /// The entry point: visit \\a e.
    virtual void operator() (typename Const<ast::Ast>::type& e);
"""
arr = nodes.values ()
arr.sort (lambda x, y: cmp(x.name, y.name))
for node in arr:
  if node.concrete:
    print "    virtual void operator() (typename Const<" \
	  + node.name + ">::type&) = 0;"
print """
  };

  /// Shorthand for a const visitor.
  typedef GenVisitor<libport::constify_traits> ConstVisitor;
  /// Shorthand for a non const visitor.
  typedef GenVisitor<libport::id_traits> Visitor;

} // namespace ast

# include "ast/visitor.hxx"

#endif // !AST_VISITOR_HH"""

# Restore stdout and close files
sys.stdout = sys.__stdout__
visitor_hh.close ()
tools.lazy_install (srcdir, "visitor.hh")
