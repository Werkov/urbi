#!/usr/bin/env python

import sys
import ast, tools

if len (sys.argv) != 2:
  tools.error("Usage: .. SRCDIR")
srcdir = sys.argv[1]

## Abstract syntax tree C++ forward declarations ------------------------------
loader = ast.Loader ()
nodes, ast_params = loader.load (sys.stdin)

fwd_hh = file ("fwd.hh.tmp", "w")
print >>fwd_hh, tools.banner("ast/fwd.hh",
			     """Forward declarations of all AST classes
 ** (needed by the visitors).""") + """
#ifndef AST_FWD_HH
# define AST_FWD_HH
"""

print >>fwd_hh, ast_params['fwd_hh_prologue']

print >>fwd_hh, """
namespace ast
{
"""

arr = nodes.values ()
arr.sort (lambda x, y: cmp (x.name, y.name))
for node in arr:
  print >>fwd_hh, "  class " + node.name + ";"

print >>fwd_hh, """

  // From visitor.hh
  template <template <typename> class Const>
  class GenVisitor;
  typedef GenVisitor<libport::constify_traits> ConstVisitor;
  typedef GenVisitor<libport::id_traits> Visitor;
"""

print >>fwd_hh, ast_params['fwd_hh_epilogue']

print >>fwd_hh, """

} // namespace ast

#endif // !AST_FWD_HH"""

fwd_hh.close ()
tools.lazy_install (srcdir, "fwd.hh");
