#!/usr/bin/env python

import sys
import ast, tools

if len (sys.argv) != 2:
  tools.error("Usage: .. SRCDIR")
srcdir = sys.argv[1]

## Abstract syntax tree C++ forward declarations ------------------------------
loader = ast.Loader ()
nodes = loader.load (sys.stdin)

fwd_hh = file ("fwd.hh.tmp", "w")
sys.stdout = fwd_hh

print """\
//<<-
// Generated, do not edit by hand.
//->>
/**
 ** \\file ast/fwd.hh
 ** \\brief Forward declarations of all node-classes of AST
 ** (needed by the visitors)
 */
#ifndef AST_FWD_HH
# define AST_FWD_HH

# include <list>
# include "libport/fwd.hh"

namespace ast
{
"""
arr = nodes.values ()
arr.sort (lambda x, y: cmp (x.name, y.name))
for node in arr:
  print "  class " + node.name + ";"
print """

  // List types.
  typedef std::list<Exp*> exps_type;
  typedef std::pair<Exp*, Exp*> exp_pair_type;
  typedef std::list<exp_pair_type> exp_pairs_type;
  typedef std::list<VarDec*> vardecs_type;
  typedef std::list<Dec*> decs_type;

  // From visitor.hh
  template <template <typename> class Const>
  class GenVisitor;
  typedef GenVisitor<libport::constify_traits> ConstVisitor;
  typedef GenVisitor<libport::id_traits> Visitor;

} // namespace ast

#endif // !AST_FWD_HH"""

# Restore stdout and close files
sys.stdout = sys.__stdout__
fwd_hh.close ()

tools.lazy_install (srcdir, "fwd.hh");
