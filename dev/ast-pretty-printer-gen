#!/usr/bin/env python

import re
import sys, os, os.path, filecmp, shutil, stat
import ast, tools

if len(sys.argv) != 2:
  tools.error("Usage: .. SRCDIR")
srcdir = sys.argv[1]

## Abstract syntax tree C++ visitor - header ----------------------------------
loader = ast.Loader ()
nodes = loader.load (sys.stdin)


## --------------- ##
## The *.hh file.  ##
## --------------- ##

visitor_hh = file("pretty-printer.hh.tmp", "w")
sys.stdout = visitor_hh

print tools.banner("ast/pretty-printer.hh",
		   "Definition of ast::PrettyPrinter.") + """
#ifndef AST_PRETTY_PRINTER_HH
# define AST_PRETTY_PRINTER_HH

# include <iosfwd>

# include "libport/indent.hh"
# include "libport/pair.hh"
# include "libport/separator.hh"

# include "ast/default-visitor.hh"

namespace ast
{

  /// Ast pretty-printer.
  class PrettyPrinter : public DefaultConstVisitor
  {
    /** \\name Ctor & dtor.
     ** \\{ */
  public:
    /// Super class type.
    typedef DefaultConstVisitor super_type;

    /// Construct a PrettyPrinter.
    PrettyPrinter (std::ostream& s);

    /// Destroy a PrettyPrinter.
    virtual ~PrettyPrinter ();
    /** \\} */

    using super_type::operator();
"""
arr = nodes.values ()
arr.sort (lambda x, y: cmp(x.name, y.name))
for node in arr:
  if 'printer' in node.__dict__:
    print "    virtual void operator() (const %s&);" % (node.name)

print """
  private:
    // The stream we output to.
    std::ostream& ostr_;
  };

  std::ostream& operator<< (std::ostream& o, const Ast& a);

} // namespace ast

# include "ast/pretty-printer.hxx"

#endif // !AST_PRETTY_PRINTER_HH
"""


## ---------------- ##
## The *.hxx file.  ##
## ---------------- ##

visitor_hxx = file("pretty-printer.hxx.tmp", "w")
sys.stdout = visitor_hxx

print tools.banner("ast/pretty-printer.hxx",
		   "Inline implementation of ast::PrettyPrinter.") + """

#ifndef AST_PRETTY_PRINTER_HXX
# define AST_PRETTY_PRINTER_HXX

# include "pretty-printer.hh"

namespace ast
{

  inline
  std::ostream&
  operator<< (std::ostream& o, const Ast& a)
  {
    PrettyPrinter p (o);
    p(a);
    return o;
  }

  inline
  PrettyPrinter::PrettyPrinter (std::ostream& ostr)
    : ostr_ (ostr)
  {
  }

  inline
  PrettyPrinter::~PrettyPrinter ()
  {
  }

} // namespace ast

#endif // !AST_PRETTY_PRINTER_HXX
"""

## --------------- ##
## The *.cc file.  ##
## --------------- ##


visitor_cc = file("pretty-printer.cc.tmp", "w")
sys.stdout = visitor_cc

print tools.banner("ast/pretty-printer.cc",
		   "Implementation of ast::PrettyPrinter.") + """
#include <ostream>
#include "pretty-printer.hh"
#include "all.hh"

namespace ast
{

"""

for node in arr:
  # The name of the formal argument, if needed, with a leading space.
  name = ''
  action = ''
  if 'printer' in node.__dict__: # if a printer is defined
    for a in node.printer: # for each action in the printer
      a = a.lstrip(' ').rstrip(' ')
      if a[0] == '~':
	# Handle '~foo' variables
	name = ' n'
	action += '    n.%s_get().accept(*this);\n' % (a[1:])
      else:
	# Handle '$foo' variables
	p = re.compile('\\$(\\w*)')
	if p.search(a):
	  name = ' n'
	  a = p.sub('n.\\1_get()', a)
	action += '    ostr_ << %s;\n' % (a)
    print """\
  void PrettyPrinter::operator() (const %s&%s)
  {
%s  }
""" % (node.name, name, action)

print """} // namespace ast
"""


# Restore stdout and close files
sys.stdout = sys.__stdout__
visitor_hh.close ()
visitor_hxx.close ()
visitor_cc.close ()

tools.lazy_install (srcdir, "pretty-printer.hh")
tools.lazy_install (srcdir, "pretty-printer.hxx")
tools.lazy_install (srcdir, "pretty-printer.cc")
