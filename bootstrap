#! /bin/sh

stderr ()
{
  echo >&2 "$0: $@"
}

fatal ()
{
  stderr "$0: $@"
  exit 1
}

# Failures do matter.
set -e

# The ast/ is generated, including its Makefile.
if test -f dev/ast-nodes-mk-gen && test -f src/ast/ast.yml; then
  python_check_mod_syck='
import sys, imp
try:
  imp.find_module("syck")
except ImportError:
  sys.exit(1)
'
  if ! python -c ''; then
    fatal "python is required"
  elif ! python -c "$python_check_mod_syck"; then
    fatal "Python module \`syck' is required"
  fi

  python dev/ast-nodes-mk-gen src/ast <src/ast/ast.yml \
    || {
      rv=$?
      cat >&2 <<EOF

-----------------------------------------------------------------------
If the last error is "./bootstrap: Python module \`yaml' is required"
then you need to install Python Bindings for Yaml.

See README.
EOF
      (exit $rv); exit $rv
    }
fi

# Finally, install the GNU Build System and our submodules.
exec sdk-remote/libport/build-aux/bootstrap "$@"
