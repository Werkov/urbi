#!/bin/sh

run ()
{
    echo "$@"
    eval "$@"
}

fatal ()
{
    echo 1>&2 "$@"
    exit 1
}

older ()
{
  test ! -e "$1" || test -ot "$1" "$2"
}

set -ex

BOOST=$(pkg-config --print-errors boost-1.38 --variable=prefix)
CC='ccache gcc'
CXX='ccache g++'
CPPFLAGS='-I "$HOME/local/include"'
LDFLAGS='-I "$HOME/local/lib"'

case $(uname -n) in
  (bf-4) DOC=;;
  (*)    DOC='--disable-doc';;
esac

case "$BUILDFARM_MODE" in
  (release*) COMPILATION_MODE="speed";;
  (debug*)   COMPILATION_MODE="debug";;
  (*)   fatal "invalid buildfarm mode: $BUILDFARM_MODE"
esac

if $(older "$DIR_SOURCE/configure" "$0"); then
    cd "$DIR_SOURCE"
    ./bootstrap
fi

if $(older "$DIR_BUILD/Makefile" "$0"); then
    cd "$DIR_BUILD"
    run "$DIR_SOURCE/configure" --with-boost="$BOOST" "$DOC" --enable-headers-install CPPFLAGS="$CPPFLAGS" LDFLAGS="$LDFLAGS" --prefix=/prefix
fi
