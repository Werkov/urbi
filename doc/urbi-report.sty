% Number subsubsections and include them in the TOC
\setcounter{secnumdepth}{3}
\setcounter{tocdepth}{3}

%% ---------- %%
%% Packages.  %%
%% ---------- %%

% Margin width chosen so that 80 columns are displayed in listings.
% This is needed to display nicely the banner of urbiScript
% interactive sessions.
\RequirePackage[a4paper,hmargin=2.5cm]{geometry}

\RequirePackage{afterpage}
\RequirePackage{graphicx}
\RequirePackage[utf8]{inputenc}
\RequirePackage{mycxx}
\RequirePackage{placeins}
\RequirePackage{supertabular}
\RequirePackage{texi}
\RequirePackage{xspace}
\RequirePackage[draft,margin]{fixme}

%% ------------ %%
%% Shorthands.  %%
%% ------------ %%

\newcommand{\ai}{AI\xspace}
\newcommand{\api}{API\xspace}
\newcommand{\caml}{Caml\xspace}
\newcommand{\io}{Io\xspace}
\newcommand{\java}{Java\xspace}
\newcommand{\js}{JavaScript\xspace}
\newcommand{\lisp}{Lisp\xspace}
\newcommand{\lua}{Lua\xspace}
\newcommand{\matlab}{MatLab\xspace}
\newcommand{\pascal}{Pascal\xspace}
\newcommand{\python}{Python\xspace}
\newcommand{\ruby}{Ruby\xspace}
\newcommand{\sdk}{SDK\xspace}
\newcommand{\umake}{\command{umake}\xspace}
\newcommand{\urbi}{Urbi\xspace}
\newcommand{\us}{urbiScript\xspace}


\newtheorem{note}{Note}
\newtheorem{example}{Example}

\newenvironment{windows}
{%
  \paragraph{Windows Issues}%
  \begin{quote}%
    \itshape%
  }{%
  \end{quote}%
}

%% -------- %%
%% Floats.  %%
%% -------- %%

% Don't insert a float at the top of a page before it's referred to!
\RequirePackage{flafter}

\newcommand   {\floatpos}          {htbp}
\newcommand   {\floatposh}         {!htb}
\newcommand   {\flushfloat}        {\afterpage{\clearpage}}
\setcounter   {topnumber}          {3} % Enable up to n floats at the top of pages
\setcounter   {bottomnumber}       {2} % Enable up to n floats at the bottom of pages
\renewcommand {\floatpagefraction} {0.8}


%% ---------- %%
%% Listings.  %%
%% ---------- %%

\RequirePackage{mylistings}

\definecolor{keyword}{rgb}{0.2,0.2,0.8}
\definecolor{comment}{rgb}{0.8,0.5,0}
\definecolor{string}{rgb}{0.0,0.5,0.0}
\definecolor{bg}{rgb}{0.9,0.9,1}

% For some reason "\color{Foo}" does not work as expected with tex4ht,
% so use \textcolor.
\@ifpackageloaded{tex4ht}{
  \newcommand{\keywordstyle}[1]{\bfseries\textcolor{blue}{#1}}
  \newcommand{\commentstyle}[1]{\bfseries\textcolor{red}{#1}}
  \newcommand{\stringstyle}[1]{\bfseries\textcolor{green}{#1}}
}{
  \newcommand{\keywordstyle}[1]{\bfseries\textcolor{keyword}{#1}}
  \newcommand{\commentstyle}[1]{\bfseries\textcolor{comment}{#1}}
  \newcommand{\stringstyle}[1]{\bfseries\textcolor{string}{#1}}
}

\lstset{
  basicstyle=\ttfamily,
  backgroundcolor=\color{bg},
  keywordstyle=\keywordstyle,
  commentstyle=\commentstyle,
  stringstyle=\stringstyle,
  aboveskip=.6cm,
  captionpos=b,
  frame=single,
  showstringspaces=false,
  % Always enable the use of \var{} in listings, including C++.
  moredelim=[is][\ttfamily\itshape]{\\var\{}{\}},
}

% This is so that \lstinline corresponds to urbiScript code in normal
% size.
\lstset{language=[interactive]Urbi}

% This is so that code examples use a small font.
\lstnewenvironment{urbiscript}[1][]
  {\lstset{language=[interactive]urbi,
      basicstyle=\ttfamily\footnotesize,
      floatplacement=\floatposh,
      #1}}
  {}

% Same as above, but the content is not checked.  Should be avoided.
\lstnewenvironment{urbifixme}[1][]
  {\lstset{language=[interactive]urbi,
      basicstyle=\ttfamily\footnotesize,
      floatplacement=\floatposh,
      #1}}
  {}

\lstdefinelanguage[]{Shell}%
{%
  morekeywords={%
    case,%
    do,%
    done,%
    elif,%
    else,%
    esac,%
    exit,%
    export,%
    expr,%
    fi,%
    for,%
    if,%
    in,%
    local,%
    return,%
    test,%
    then,%
    while%
  },%
  otherkeywords=[2]{\&},
  sensitive=true,%
  morecomment=[l]{\#},%
  morestring=[b]{"}%
}[keywords,comments,strings]%

\lstnewenvironment{shell}[1][]
  {\lstset{language=Shell,
      basicstyle=\ttfamily\footnotesize,
      moredelim=[is][\ttfamily\itshape]{\\var\{}{\}},
      #1}}
  {}

\lstnewenvironment{cxx}[1][]
  {\lstset{language=C++,
      basicstyle=\ttfamily\footnotesize,
      #1}}
  {}

\newenvironment{cxxapi}
{%
  \begin{description}%
    \let\itemOrig\item%
    \renewcommand{\item}[1][]{\itemOrig[] \lstinline[language=C++]|##1|~\\}%
  }{%
  \end{description}%
}

%% ----------- %%
%% maketitle.  %%
%% ----------- %%

\renewcommand{\maketitle}{
  \begin{titlepage}

    \vfill

    \begin{figure}[htp]
      \centering
      \includegraphics[width=12cm]{img/urbi-logo}
    \end{figure}

    \begin{center}
      {\Huge\bf\@title\\}
      \ifx\empty\@subtitle\else%
        \vspace{.5cm}
        \noindent\textbf{\LARGE \@subtitle}\par\nobreak%
      \fi%
      \vspace{1cm}
      {\LARGE \@author\\}
      \vspace{1cm}
      {\Large \@date\\}
    \end{center}

    \vfill

    \begin{figure}[htp]
      \centering
      \includegraphics[width=12cm]{img/gostai}
    \end{figure}
%
%    \vfill
%    \global\let\title\relax
  \end{titlepage}
}
\newcommand{\subtitle}[1]{\def\@subtitle{#1}}
\subtitle{}

%% ---------- %%
%% Hyperref.  %%
%% ---------- %%
\RequirePackage{myhyperref}
\hypersetup{colorlinks, citecolor=blue, linkcolor=blue, urlcolor=blue}

%% Wikipedia.
\newcommand{\wref}[2][\empty]{%
  \ifx#1\empty%
    \href{http://en.wikipedia.org/wiki/#2}{#2}%
  \else%
    \href{http://en.wikipedia.org/wiki/#1}{#2}%
  \fi%
}


%% \labelObject{ ObjectName }
%% --------------------------
%% Define a label for an USL (Urbi Standard Library) class name.
\newcommand{\labelObject}[1]
  {\label{sec:std-#1}}

%% \refObject[Plural]{ ObjectName }
%% --------------------------------
%% Point to the definition of an USL class.
\newcommand{\refObject}[2][]
  {\hyperref[sec:std-#2]{\lstinline|#2|#1 (\autoref*{sec:std-#2})}}

%% \autorefObject{ ObjectName }
%% ----------------------------
%% Same as above, but point to the section without spelling the class
%% name.
\newcommand{\autorefObject}[1]
  {\autoref{sec:std-#1}}

%% FIXME: I don't know how to return to \newline here :(
%% \begin{labeled}{MacroName}
\newenvironment{labeled}[1]%
  {\begin{list}{}{%
        \def\@labeled@temp@a{\let\@labeled@MakeLabel}%
        \expandafter\@labeled@temp@a \csname #1 \endcsname %
        \renewcommand{\makelabel}[1]{\@labeled@MakeLabel{##1}\hfill\break}}}%
  {\end{list}}

%% A list of \env, \file, \option.
%% I don't know how to factor.
\newenvironment{envs}%
  {\begin{list}{}{%
    \renewcommand{\makelabel}[1]%
       {\index{##1@\env{##1}}\env{##1}\hfill\break}}}%
  {\end{list}}

\newenvironment{files}%
  {\begin{list}{}{%
    \renewcommand{\makelabel}[1]%
       {\index{##1@\file{##1}}\file{##1}\hfill\break}}}%
  {\end{list}}

\newenvironment{files*}%
  {\begin{list}{}{%
    \renewcommand{\makelabel}[1]%
       {\file{##1}\hfill\break}}}%
  {\end{list}}

\newenvironment{options}%
  {\begin{list}{}{%
    \renewcommand{\makelabel}[1]%
       {\index{##1@\option{##1}}\option{##1}\hfill\break}}}%
  {\end{list}}
