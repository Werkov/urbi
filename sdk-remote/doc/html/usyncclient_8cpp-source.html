<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>liburbi-cpp: usyncclient.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>usyncclient.cpp</h1><div class="fragment"><pre class="fragment">00001 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
00002 <span class="preprocessor">#include &lt;semaphore.h&gt;</span>
00003 <span class="preprocessor">#include "<a class="code" href="usyncclient_8h.html">usyncclient.h</a>"</span>
00004 <span class="keyword">using</span> std::min;
00005 USyncClient::USyncClient(<span class="keyword">const</span> <span class="keywordtype">char</span> *_host, <span class="keywordtype">int</span> _port, <span class="keywordtype">int</span> _buflen) : 
00006   <a class="code" href="classUClient.html">UClient</a>(_host, _port, _buflen) {
00007 }
00008 
00009 
00010 
00011 <span class="keyword">struct </span>USyncStruct
00012 {
00013   <a class="code" href="classUMessage.html">UMessage</a> *msg;
00014   sem_t semlock;
00015 
00016   <span class="comment">//UrbiSoundCopy</span>
00017   <a class="code" href="classUSound.html">USound</a> sound; <span class="comment">//for format referece</span>
00018   <span class="keywordtype">void</span> * buffer;
00019   <span class="keywordtype">int</span> pos;
00020   <span class="keywordtype">int</span> size;
00021 };
00022 
00023 
00024 <span class="keyword">static</span> <a class="code" href="uabstractclient_8h.html#a47">UCallbackAction</a> URBIUnlock(<span class="keywordtype">void</span> *cbData, <span class="keyword">const</span> <a class="code" href="classUMessage.html">UMessage</a> &amp;msg)
00025 {
00026   USyncStruct *s = (USyncStruct *) cbData;
00027   s-&gt;msg = <span class="keyword">new</span> <a class="code" href="classUMessage.html">UMessage</a>(msg, <span class="keyword">true</span>);
00028   sem_post(&amp;s-&gt;semlock);
00029   <span class="keywordflow">return</span> URBI_REMOVE;
00030 }
00031 
00032 
00033 <span class="keywordtype">int</span> 
<a name="l00034"></a><a class="code" href="classUSyncClient.html#a2">00034</a> <a class="code" href="classUSyncClient.html#a2">USyncClient::syncGetImage</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *camera, 
00035                               <span class="keywordtype">void</span> *buffer, <span class="keywordtype">int</span> &amp;buffersize, 
00036                               <span class="keywordtype">int</span> format, <span class="keywordtype">int</span> transmitFormat, 
00037                               <span class="keywordtype">int</span> &amp;width, <span class="keywordtype">int</span> &amp;height)
00038 {
00039   USyncStruct s;
00040   sem_init(&amp;s.semlock, 0, 0);
00041   <span class="keywordtype">int</span> f;
00042   <span class="keywordflow">if</span> ( (format == IMAGE_JPEG)  || (transmitFormat == URBI_TRANSMIT_JPEG))
00043     f = 1;
00044   <span class="keywordflow">else</span>
00045     f = 0;
00046   <a class="code" href="classUAbstractClient.html#a3">send</a>(<span class="stringliteral">"%s.format = %d;noop;noop;"</span>, camera, f); <span class="comment">//XXX required to ensure format change is applied</span>
00047   <a class="code" href="classUAbstractClient.html#a12">sendCommand</a>(URBIUnlock, &amp;s, <span class="stringliteral">"%s.val;"</span>, camera);
00048   sem_wait(&amp;s.semlock);
00049   sem_destroy(&amp;s.semlock);
00050   <span class="keywordflow">if</span> (s.msg-&gt;binaryType != BINARYMESSAGE_IMAGE) {
00051     <span class="keyword">delete</span> s.msg;
00052     <span class="keywordflow">return</span> 0;
00053   }
00054   width = s.msg-&gt;image.width;
00055   height = s.msg-&gt;image.height;
00056 
00057   <span class="keywordtype">int</span> osize = buffersize;
00058   <span class="keywordflow">if</span> (f == 1  &amp;&amp;  format != IMAGE_JPEG ) {      <span class="comment">//uncompress jpeg</span>
00059     <span class="keywordflow">if</span> (format == IMAGE_YCbCr)
00060       convertJPEGtoYCrCb((<span class="keyword">const</span> byte *) s.msg-&gt;image.data, s.msg-&gt;image.size, 
00061                          (byte *) buffer, buffersize);
00062     <span class="keywordflow">else</span>
00063       convertJPEGtoRGB((<span class="keyword">const</span> byte *)  s.msg-&gt;image.data, s.msg-&gt;image.size,
00064                        (byte *) buffer, buffersize);
00065   }
00066   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (format == <a class="code" href="uabstractclient_8h.html#a50a25">IMAGE_RGB</a> || format == IMAGE_PPM) {
00067     buffersize = min(s.msg-&gt;image.size, buffersize);
00068     convertYCrCbtoRGB((<span class="keyword">const</span> byte *) s.msg-&gt;image.data, buffersize, (byte *) buffer);
00069     
00070   }
00071   <span class="keywordflow">else</span> { <span class="comment">//jpeg jpeg, or ycrcb ycrcb</span>
00072     buffersize = min(s.msg-&gt;image.size, buffersize);
00073     memcpy(buffer, s.msg-&gt;image.data, buffersize);
00074   }
00075   <span class="keywordflow">if</span> (format == IMAGE_PPM) {
00076     <span class="keywordtype">char</span> p6h[20];
00077     sprintf(p6h, <span class="stringliteral">"P6\n%d %d\n255\n"</span>, width, height);
00078     <span class="keywordtype">int</span> p6len = strlen(p6h);
00079     <span class="keywordtype">int</span> mlen = osize &gt; buffersize + p6len ? buffersize : osize - p6len;
00080     memmove((<span class="keywordtype">void</span> *) (((<span class="keywordtype">int</span>) buffer) + p6len), buffer, mlen);
00081     memcpy(buffer, p6h, p6len);
00082     buffersize += p6len;
00083   }
00084   <span class="keyword">delete</span> s.msg;
00085   <span class="keywordflow">return</span> 1;
00086 }
00087 
00088 
00089 <span class="keywordtype">int</span> 
<a name="l00090"></a><a class="code" href="classUSyncClient.html#a5">00090</a> <a class="code" href="classUSyncClient.html#a5">USyncClient::syncGetNormalizedDevice</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *device, <span class="keywordtype">double</span> &amp;val)
00091 {
00092   USyncStruct s;
00093   sem_init(&amp;s.semlock, 0, 0);
00094   <a class="code" href="classUAbstractClient.html#a12">sendCommand</a>(URBIUnlock, &amp;s, <span class="stringliteral">"%s.valn;"</span>, device);
00095   sem_wait(&amp;s.semlock);
00096   sem_destroy(&amp;s.semlock);
00097   <span class="keywordflow">if</span> (s.msg-&gt;type != MESSAGE_DOUBLE) {
00098     <span class="keyword">delete</span> s.msg;
00099     <span class="keywordflow">return</span> 0;
00100   }
00101   val = s.msg-&gt;doubleValue;
00102   <span class="keywordflow">return</span> 1;
00103 }
00104 
00105 <span class="keywordtype">int</span> 
<a name="l00106"></a><a class="code" href="classUSyncClient.html#a3">00106</a> <a class="code" href="classUSyncClient.html#a3">USyncClient::syncGetDevice</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *device, <span class="keywordtype">double</span> &amp;val)
00107 {
00108   USyncStruct s;
00109   sem_init(&amp;s.semlock, 0, 0);
00110   <a class="code" href="classUAbstractClient.html#a12">sendCommand</a>(URBIUnlock, &amp;s, <span class="stringliteral">"%s.val;"</span>, device);
00111   sem_wait(&amp;s.semlock);
00112   sem_destroy(&amp;s.semlock);
00113   <span class="keywordflow">if</span> (s.msg-&gt;type != MESSAGE_DOUBLE) {
00114     <span class="keyword">delete</span> s.msg;
00115     <span class="keywordflow">return</span> 0;
00116   }
00117   val = s.msg-&gt;doubleValue;
00118   <span class="keywordflow">return</span> 1;
00119 }
00120 
00121 <span class="keywordtype">int</span> 
<a name="l00122"></a><a class="code" href="classUSyncClient.html#a4">00122</a> <a class="code" href="classUSyncClient.html#a4">USyncClient::syncGetResult</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* command, <span class="keywordtype">double</span> &amp;val) {
00123   USyncStruct s;
00124   sem_init(&amp;s.semlock, 0, 0);
00125   <a class="code" href="classUAbstractClient.html#a12">sendCommand</a>(URBIUnlock, &amp;s, command);
00126   sem_wait(&amp;s.semlock);
00127   sem_destroy(&amp;s.semlock);
00128   <span class="keywordflow">if</span> (s.msg-&gt;type != MESSAGE_DOUBLE) {
00129     <span class="keyword">delete</span> s.msg;
00130     <span class="keywordflow">return</span> 0;
00131   }
00132   val = s.msg-&gt;doubleValue;
00133   <span class="keywordflow">return</span> 1;
00134 }
00135 
00136 
00137 <span class="keywordtype">int</span> 
<a name="l00138"></a><a class="code" href="classUSyncClient.html#a6">00138</a> <a class="code" href="classUSyncClient.html#a3">USyncClient::syncGetDevice</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *device, <span class="keyword">const</span> <span class="keywordtype">char</span> * access, 
00139                            <span class="keywordtype">double</span> &amp;val)
00140 {
00141   USyncStruct s;
00142   sem_init(&amp;s.semlock, 0, 0);
00143   <a class="code" href="classUAbstractClient.html#a12">sendCommand</a>(URBIUnlock, &amp;s, <span class="stringliteral">"%s.%s;"</span>, device,access);
00144   sem_wait(&amp;s.semlock);
00145   sem_destroy(&amp;s.semlock);
00146   <span class="keywordflow">if</span> (s.msg-&gt;type != MESSAGE_DOUBLE) {
00147     <span class="keyword">delete</span> s.msg;
00148     <span class="keywordflow">return</span> 0;
00149   }
00150   val = s.msg-&gt;doubleValue;
00151   <span class="keywordflow">return</span> 1;
00152 }
00153 
00154 <span class="keyword">static</span> <a class="code" href="uabstractclient_8h.html#a47">UCallbackAction</a> URBISoundCopy(<span class="keywordtype">void</span> *cbData, <span class="keyword">const</span> <a class="code" href="classUMessage.html">UMessage</a> &amp;msg) {
00155    USyncStruct *s = (USyncStruct *) cbData;
00156    <span class="keywordflow">if</span> (msg.<a class="code" href="classUMessage.html#o3">type</a> != MESSAGE_BINARY || msg.<a class="code" href="classUMessage.html#o4">binaryType</a> != BINARYMESSAGE_SOUND) {
00157      sem_post(&amp;s-&gt;semlock);
00158      <span class="keywordflow">return</span> URBI_REMOVE;
00159    }
00160    s-&gt;sound = msg.<a class="code" href="classUMessage.html#o10">sound</a>;
00161    <span class="keywordflow">if</span> (s-&gt;size &lt; s-&gt;pos+msg.<a class="code" href="classUMessage.html#o10">sound</a>.<a class="code" href="classUSound.html#o1">size</a>) s-&gt;buffer = realloc(s-&gt;buffer, msg.<a class="code" href="classUMessage.html#o10">sound</a>.<a class="code" href="classUSound.html#o1">size</a>+s-&gt;pos);
00162    s-&gt;<a class="code" href="classUSound.html#o1">size</a> = msg.<a class="code" href="classUMessage.html#o10">sound</a>.<a class="code" href="classUSound.html#o1">size</a>+s-&gt;pos;
00163    memcpy((<span class="keywordtype">char</span>*)(s-&gt;buffer)+s-&gt;pos, msg.<a class="code" href="classUMessage.html#o10">sound</a>.<a class="code" href="classUSound.html#o0">data</a>, msg.<a class="code" href="classUMessage.html#o10">sound</a>.<a class="code" href="classUSound.html#o1">size</a>);
00164    s-&gt;pos +=msg.<a class="code" href="classUMessage.html#o10">sound</a>.<a class="code" href="classUSound.html#o1">size</a>;
00165    <span class="keywordflow">return</span> URBI_CONTINUE;
00166 }
00167 
00168 
00169 <span class="keywordtype">int</span> 
<a name="l00170"></a><a class="code" href="classUSyncClient.html#a7">00170</a> <a class="code" href="classUSyncClient.html#a7">USyncClient::syncGetSound</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * device, <span class="keywordtype">int</span> duration, <a class="code" href="classUSound.html">USound</a> &amp;sound)
00171 {
00172   USyncStruct s;
00173   sem_init(&amp;s.semlock, 0, 0);
00174   s.buffer=sound.<a class="code" href="classUSound.html#o0">data</a>;
00175   s.pos=0;
00176   s.<a class="code" href="classUSound.html#o1">size</a>=sound.<a class="code" href="classUSound.html#o1">size</a>;
00177   <a class="code" href="classUAbstractClient.html#a17">setCallback</a>(&amp;URBISoundCopy, &amp;s, <span class="stringliteral">"susound"</span>);
00178   <a class="code" href="classUAbstractClient.html#a3">send</a>(<span class="stringliteral">"loopsound: loop susound: %s.val ,   { wait(%d); stop loopsound; noop;noop; susound:ping },"</span>, device, duration);
00179   sem_wait(&amp;s.semlock);
00180   sem_destroy(&amp;s.semlock);
00181   s.sound.<a class="code" href="classUSound.html#o0">data</a> = sound.<a class="code" href="classUSound.html#o0">data</a>;
00182   s.sound.<a class="code" href="classUSound.html#o1">size</a> = sound.<a class="code" href="classUSound.html#o1">size</a>;
00183   <span class="keywordflow">if</span> (! (s.sound == sound)) {
00184     <span class="comment">//conversion required</span>
00185     sound.<a class="code" href="classUSound.html#o0">data</a> = 0;
00186     sound.<a class="code" href="classUSound.html#o1">size</a> = 0;
00187     s.sound.<a class="code" href="classUSound.html#o0">data</a> = (<span class="keywordtype">char</span> *)s.buffer;
00188     s.sound.<a class="code" href="classUSound.html#o1">size</a> = s.pos;
00189     <a class="code" href="uabstractclient_8h.html#a39">convert</a>(s.sound, sound);
00190   }
00191   <span class="keywordflow">else</span> {
00192     sound.<a class="code" href="classUSound.html#o0">data</a> = (<span class="keywordtype">char</span> *)s.buffer;
00193     sound.<a class="code" href="classUSound.html#o1">size</a> = s.pos;
00194   }
00195   <span class="keywordflow">return</span> 0;
00196 }
00197 
00198 <span class="keywordtype">int</span> 
<a name="l00199"></a><a class="code" href="classUSyncClient.html#a1">00199</a> <a class="code" href="classUSyncClient.html#a1">USyncClient::syncSend</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> * buffer, <span class="keywordtype">int</span> length) {
00200   <span class="keywordflow">if</span> (rc !=0) <span class="keywordflow">return</span> -1;
00201   <a class="code" href="classUClient.html#a6">lockSend</a>();
00202   <span class="keywordtype">int</span> sent = 0;
00203   <span class="keywordflow">while</span> (sent&lt;length) {
00204     <span class="keywordtype">int</span> res = ::write(sd, (<span class="keywordtype">char</span> *) buffer + sent, length - sent);
00205     <span class="keywordflow">if</span> (res &lt; 0) {
00206       rc = res;
00207       <a class="code" href="classUClient.html#a7">unlockSend</a>();
00208       <span class="keywordflow">return</span> res;
00209     }
00210     sent +=res;
00211   }
00212   <a class="code" href="classUClient.html#a7">unlockSend</a>();
00213   <span class="keywordflow">return</span> 0;
00214 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Sep 21 08:43:20 2005 for liburbi-cpp by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
