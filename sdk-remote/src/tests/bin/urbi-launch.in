#! @SHELL@
# @configure_input@

: ${EXEEXT='@EXEEXT@'}
: ${LIBSFX='@LIBSFX@'}
: ${sdk_remote_builddir='@abs_top_builddir@'}
: ${sdk_remote_srcdir='@abs_top_srcdir@'}

: ${program=$sdk_remote_builddir/src/bin/urbi-launch$EXEEXT}

###################### Common between urbi-launch.in and urbi.in: begin.

set -e

case $VERBOSE in
  (x) set -x;;
esac

stderr ()
{
  local i
  for i
  do
    echo >&2 "$0: $i"
  done
}

verbose ()
{
  test -z "$VERBOSE" ||
    stderr "$@"
}

# prependenv VAR VAL
# ------------------
# Set env verbosely $VAR=$VAL.
setenv ()
{
  eval "$1=\$2"
  export $1
  verbose "$1 = $2"
}

# prependenv VAR VAL
# ------------------
# Set env verbosely $VAR=$VAL${$VAR}.
prependenv ()
{
  local val
  eval "val=\$2\$$1"
  setenv "$1" "$val"
}

# ld_path_add DIR...
# ------------------
# Extend the appropriate envvar so that shared libraries in DIR... will
# be found.
ld_path_add ()
{
  local d
  local ds=
  for d
  do
    if test -d $d; then
      ds="$ds$d:"
    fi
  done
  case $(uname -s) in
    (CYGWIN*) prependenv PATH "$ds" ;;
    (Darwin)  prependenv DYLD_LIBRARY_PATH "$ds";;
    (*)       prependenv LD_LIBRARY_PATH "$ds";;
  esac
}

# repath PATH
# -----------
# Set $repath_res to the native path.
repath ()
{
  case $(uname -s) in
    (CYGWIN*)  repath_res=$(cygpath --windows "$1");;
    (*)        repath_res=$1;;
  esac
}

# urbi_lib BASENAME PATH
urbi_lib ()
{
  local base=$1
  local path="$2$LIBSFX"
  repath "$path"
  setenv "URBI_ROOT_LIB$base" $repath_res
}

###################### Common between urbi-launch.in and urbi.in: end.

# The libuobject we load depends on the usage.
verbose "$*"
case " $* " in
  (*' --start '* | *' -s '*)
    # Spawning a new server, which requires a server.  Two cases:
    # this package is part of a kernel package, in which case we
    # should find libuobject.la in it.  Otherwise we hope a kernel
    # was installed, and the real urbi-launch will look for it at the
    # right place.
    if test -f $sdk_remote_builddir/../src/Makefile; then
      libuobjectdir=$sdk_remote_builddir/../src
      # Be sure to find the shipped Urbi files.
      URBI_PATH="$sdk_remote_srcdir/../share:$sdk_remote_builddir/../share:$URBI_PATH"
      case $(uname -o 2>/dev/null) in
        (Cygwin)
          # We use colon as separators, not semicolon.
          URBI_PATH=$(cygpath -p -w "$URBI_PATH" | sed -e 's/;/:/g')
          ;;
      esac
      export URBI_PATH
    fi
    ;;
  (*)
     libuobjectdir=$sdk_remote_builddir/src/libuobject;;
esac

if test -n "$libuobjectdir"; then
  libuobject=$libuobjectdir/.libs
  repath "$libuobject"
  libuobject=$repath_res
  set x -c "$libuobject" "$@"
  shift
fi

# Find the noninstalled libport libraries.
libport_builddir=$sdk_remote_builddir/libport
# Careful, do not add directory containing libuobject.
ld_path_add $libport_builddir/lib/*/.libs               \
            $sdk_remote_builddir/*/.libs                \
            $sdk_remote_builddir/src/liburbi/.libs

urbi_lib JPEG      "$sdk_remote_builddir/jpeg/.libs/libjpeg"
urbi_lib PORT      "$libport_builddir/lib/libport/.libs/libport"
urbi_lib SCHED     "$libport_builddir/lib/sched/.libs/libsched"
urbi_lib SERIALIZE "$libport_builddir/lib/serialize/.libs/libserialize"
urbi_lib URBI      "$sdk_remote_builddir/src/liburbi/.libs/liburbi"

verbose "running $program $*"
exec "$program" "$@"

# Local Variables:
# mode: shell-script
# End:
