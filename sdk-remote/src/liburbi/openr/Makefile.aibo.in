srcdir = @srcdir@
top_srcdir = @top_srcdir@
prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
libdir = @libdir@
datadir = @datadir@
includedir = @includedir@

MODULENAME      = CLIENT
SRC		= 
MS		=  ./
OPENR		= @OPENR_SDK_PATH@
CXX		= $(OPENR)/bin/mipsel-linux-g++
CC		= $(OPENR)/bin/mipsel-linux-gcc
STRIP		= $(OPENR)/bin/mipsel-linux-strip
MKBIN		= $(OPENR)/OPEN_R/bin/mkbin
STUBGEN		= $(OPENR)/OPEN_R/bin/stubgen2
MKBINFLAGS	= -p $(OPENR)
LIBS		= -L$(OPENR)/OPEN_R/lib -lObjectComm -lOPENR -lInternet -lantMCOOP
URBICFLAGS	= -I$(includedir)/openr -DLIBURBI_OPENR


CXXFLAGS+= \
	-O2 \
	-I. \
	-I$(OPENR)/OPEN_R/include/R4000 \
	-I$(OPENR)/OPEN_R/include/MCOOP \
	-I$(OPENR)/OPEN_R/include 

CXXFLAGS+= -DOPENR_DEBUG

LIBURBI=$(libdir)/liburbi.mips.a

all: $(MODULENAME).cc $(MODULENAME).BIN

OBJ1 = $(SRC:.cc=.mips.o)
OBJ  = $(MODULENAME)Stub.mips.o $(MODULENAME).mips.o $(OBJ1:.cpp=.mips.o) $(MODULENAME).ocf 




$(MODULENAME)Stub.cc: stub.cfg
	$(STUBGEN) $^
	

$(MODULENAME).BIN: $(OBJ) $(LIBURBI)
	$(MKBIN) $(MKBINFLAGS) -o $@ $^ $(LIBS) 
	$(STRIP) $@

install:
	gzip -c $(MODULENAME).BIN > $(MS)/MS/OPEN-R/MW/OBJS/$(MODULENAME).BIN
	grep -q $(MODULENAME).BIN $(MS)/MS/OPEN-R/MW/CONF/OBJECT.CFG || \
		echo  /MS/OPEN-R/MW/OBJS/$(MODULENAME).BIN >> $(MS)/MS/OPEN-R/MW/CONF/OBJECT.CFG

	grep -q $(MODULENAME)  $(MS)/MS/OPEN-R/MW/CONF/CONNECT.CFG || echo -e "OVirtualRobotComm.FbkImageSensor.OFbkImageVectorData.S $(MODULENAME).Image.OFbkImageVectorData.O\nOVirtualRobotComm.Sensor.OSensorFrameVectorData.S $(MODULENAME).Sensor.OSensorFrameVectorData.O"  >> $(MS)/MS/OPEN-R/MW/CONF/CONNECT.CFG
		


%.mips.o: %.cc
	$(CXX) $(URBICFLAGS) $(CXXFLAGS) -o $@ -c $^

%.mips.o: %.cpp
	$(CXX) $(URBICFLAGS) $(CXXFLAGS) -o $@ -c $^

%.mips.o: %.c
	$(CC) $(URBICFLAGS) $(CXXFLAGS) -o $@ -c $^

stub.cfg: Makefile.aibo
	sed -e s/CLIENT/$(MODULENAME)/g $(datadir)/stub.cfg > ./stub.cfg

$(MODULENAME).ocf: Makefile.aibo
	sed -e s/CLIENT/$(MODULENAME)/g $(datadir)/CLIENT.ocf > ./$(MODULENAME).ocf

$(MODULENAME).cc: Makefile.aibo
	sed -e s/CLIENT/$(MODULENAME)/g $(datadir)/CLIENT.h > ./$(MODULENAME).h
	sed -e s/CLIENT/$(MODULENAME)/g -e s/$(MODULENAME)_ID/CLIENT_ID/ $(datadir)/CLIENT.cc > ./$(MODULENAME).cc

prepare:
	sed -e 's@^SRC\s*=.*$$@SRC    = $(SRC)@' Makefile.aibo > Makefile.aibo.tmp && mv Makefile.aibo.tmp Makefile.aibo
	sed -e 's/^MODULENAME\s*=.*$$/MODULENAME    = $(MODULENAME)/' Makefile.aibo > Makefile.aibo.tmp && mv Makefile.aibo.tmp Makefile.aibo
	sed -e 's@^MS\s*=.*$$@MS   = $(MS)@' Makefile.aibo > Makefile.aibo.tmp && mv Makefile.aibo.tmp Makefile.aibo
	@echo prepare done, edit Makefile.aibo for further modifications

uninstall:
	rm $(MS)/MS/OPEN-R/MW/OBJS/$(MODULENAME).BIN
	grep -v $(MODULENAME)  $(MS)/MS/OPEN-R/MW/CONF/OBJECT.CFG >  $(MS)/MS/OPEN-R/MW/CONF/OBJECT.CFG.new \
		&& mv  $(MS)/MS/OPEN-R/MW/CONF/OBJECT.CFG.new  $(MS)/MS/OPEN-R/MW/CONF/OBJECT.CFG
	grep -v $(MODULENAME)  $(MS)/MS/OPEN-R/MW/CONF/CONNECT.CFG >  $(MS)/MS/OPEN-R/MW/CONF/CONNECT.CFG.new \
		&& mv  $(MS)/MS/OPEN-R/MW/CONF/CONNECT.CFG.new  $(MS)/MS/OPEN-R/MW/CONF/CONNECT.CFG

clean:
	rm *.mips.o $(MODULENAME).BIN*
